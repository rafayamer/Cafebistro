<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Casa Bistro ‚Äì Welcome</title>
<style>
  :root{ --accent:#004643; --text:#f8fafc; --muted:#cbd5e1; }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:system-ui,Segoe UI,Roboto,Arial;
    background:url('background.jpg') center center/cover no-repeat fixed;
    color:var(--text); min-height:100vh; overflow-x:hidden; overflow-y:hidden;
  }

  .form-card,.card{
    width:100%;max-width:520px;background:rgba(0,70,67,.4);color:var(--text);
    border-radius:24px;padding:32px 28px;backdrop-filter:blur(16px) saturate(160%);
    box-shadow:0 0 30px rgba(0,70,67,.5), inset 0 0 8px rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.18);
  }

  .overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    padding:20px;background:rgba(0,0,0,.3);backdrop-filter:blur(6px);z-index:50;
    transition:opacity .35s ease;
  }

  .form-card h2{font-size:26px;font-weight:700;text-shadow:0 0 12px rgba(0,70,67,.8);margin-bottom:10px}
  .form-sub{color:var(--muted);font-size:14px;margin:0 0 20px}
  .field{display:grid;gap:6px;margin-bottom:16px}
  .label{font-size:14px;color:#e2e8f0}
  .input{
    width:100%;padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.25);
    background:rgba(0,0,0,.25);color:var(--text);font-size:16px;outline:none;transition:all .2s ease;
  }
  .input:focus{border-color:var(--accent);box-shadow:0 0 10px rgba(0,70,67,.7)}

  .btn-main,.btn,.cp,.open{
    display:flex;align-items:center;justify-content:center;gap:10px;padding:14px 18px;
    border-radius:14px;border:1px solid rgba(255,255,255,.2);background:rgba(0,70,67,.6);
    color:#fff;font-weight:700;cursor:pointer;transition:all .3s ease;text-decoration:none;
    backdrop-filter:blur(10px) saturate(120%);
  }
  .btn-main:hover,.btn:hover,.cp:hover,.open:hover{box-shadow:0 0 18px rgba(0,70,67,.9);transform:translateY(-2px)}

  .err{color:#fecaca;font-size:13px;min-height:18px;margin-top:6px}
  .note{color:#cbd5e1;font-size:12px;margin-top:12px;text-align:center}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  h1{font-size:26px;text-shadow:0 0 10px rgba(0,70,67,.7)}
  .sub{color:var(--muted);font-size:15px;margin:0 0 18px}
  .grid{display:grid;gap:14px}

  .wifiBox{background:rgba(0,70,67,.4);border:1px dashed rgba(255,255,255,.2);
    border-radius:16px;padding:16px;margin-top:16px;backdrop-filter:blur(12px)}
  .rowx{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .pill{background:rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;font-size:14px;flex:1}
  .banner{background:rgba(0,70,67,.45);border-radius:12px;padding:12px;font-size:13px;margin-top:12px;display:none}
  .banner.show{display:block}
  .hint{color:#e2e8f0;font-size:13px;margin-top:6px}
  .hidden-initial{visibility:hidden}

  /* live phone feedback */
  .input.valid{border-color:#22c55e; box-shadow:0 0 6px rgba(34,197,94,.6)}
  .input.invalid{border-color:#ef4444; box-shadow:0 0 6px rgba(239,68,68,.6)}

  @media (max-width:600px){
    .form-card,.card{padding:24px 20px;border-radius:18px}
    h1,.form-card h2{font-size:22px}
    .btn-main,.btn,.cp,.open{padding:12px 14px;font-size:15px}
  }
</style>
</head>
<body>

<!-- Check-in -->
<div id="checkinOverlay" class="overlay" role="dialog" aria-modal="true">
  <form id="checkinForm" class="form-card" novalidate>
    <h2>Welcome to Casa Bistro üëã</h2>
    <p class="form-sub">Please check in so we can serve you better.</p>

    <div class="field">
      <label class="label" for="name">Full Name</label>
      <input class="input" id="name" name="name" type="text" placeholder="e.g., Ayesha Khan" required minlength="2" maxlength="80" />
    </div>

    <div class="field">
      <label class="label" for="phone">WhatsApp / Phone</label>
      <input class="input" id="phone" name="phone" type="tel" inputmode="tel"
             placeholder="0308 1234567 or +44 7000 111111" required pattern="^[0-9+()\\s-]{8,20}$" />
    </div>

    <div class="err" id="formError"></div>
    <button id="submitBtn" class="btn-main" type="submit">
      <span id="btnText">Save & Continue</span>
      <span id="btnSpinner" aria-hidden="true" style="display:none">‚è≥</span>
    </button>
    <p class="note">By continuing you agree we may contact you about your visit and offers.</p>
  </form>
</div>

<!-- Main -->
<div id="mainRoot" class="wrap hidden-initial" aria-hidden="true">
  <div class="card">
    <h1>Welcome to Casa Bistro üëã</h1>
    <p class="sub">Choose an option below</p>

    <div class="grid">
      <a id="menuBtn" class="btn" href="casabistro final_compressed.pdf" target="_blank" rel="noopener">üìú Menu</a>
      <button id="wifiBtn" class="btn" type="button">üì∂ Join Wi-Fi</button>
    </div>

    <div id="wifiPanel" class="wifiBox" hidden>
      <div class="rowx">
        <div class="pill" id="ssidText">Casa_Guest</div>
        <button class="cp" id="copySsidBtn" type="button">Copy Name</button>
      </div>
      <div class="rowx" style="margin-top:8px">
        <div class="pill" id="passText">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
        <button class="cp" id="copyPassBtn" type="button">Copy Password</button>
      </div>

      <button id="openWifi" class="open" type="button">Open Wi-Fi Settings</button>

      <div id="iosBanner" class="banner">
        <p><b>iPhone/iPad Users:</b> Tap & hold the QR to join Wi-Fi.</p>
        <img id="wifiQR" src="qr.png" alt="Wi-Fi QR" style="display:block;margin:10px auto;width:160px;height:160px;border-radius:12px;background:#fff;padding:6px;">
        <p style="font-size:13px;margin-top:8px;color:#e5e7eb">
          Or manually connect to <b id="ssidInline">Casa_Guest</b> and paste the password you copied.
        </p>
      </div>

      <div class="hint">Tip: If your phone already knows this network, it should reconnect automatically.</div>
    </div>

    <p class="note">Trouble? Ask staff for help.</p>
  </div>
</div>

<!-- libphonenumber (global, any country validation) -->
<script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1/bundle/libphonenumber-js.min.js"></script>

<script>
/* --- Config --- */
const WIFI_SSID = "Casa_Guest";
const WIFI_PASS = "Pakistan@786";
const MENU_URL  = "casabistro final_compressed.pdf";
const QR_SRC    = "qr.png";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwW7wtqtaFsBuGnDbNdcNIT5b7fGmuz0sQpndpMgXUYL6fQWlif1evi-5g9Fx3TavkjBg/exec";

/* --- Background save helper (non-blocking) --- */
function postToSheet(payload){
  try{
    fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" }, // avoids CORS preflight
      body: JSON.stringify(payload)
    }).catch(()=>{});
  }catch(e){}
}

/* Default region from browser (fallback PK) */
function getDefaultRegion(){
  const lang = (navigator.language || '').toUpperCase();
  const m = /[-_](\w{2})$/.exec(lang);
  return (m && m[1]) ? m[1] : 'PK';
}

/* Normalize & validate with libphonenumber-js (any country) */
function normalizePhone(input){
  if(!input) return null;
  let s = String(input).trim().replace(/[\s\-()]/g,'');
  if (s.startsWith('00')) s = '+' + s.slice(2); // 00 -> +
  const def = getDefaultRegion();
  const p = window.libphonenumber?.parsePhoneNumberFromString(s, def);
  if (p && p.isValid()){
    return {
      e164: p.number,                               // "+923088581919"
      country: p.country || '',                     // "PK"
      country_code: '+' + p.countryCallingCode,     // "+92"
      national: p.nationalNumber                    // "3088581919"
    };
  }
  return null;
}

function waLink(e164){ return e164 ? "https://wa.me/" + e164.slice(1) : ""; }

/* --- Elements --- */
const overlay   = document.getElementById("checkinOverlay");
const form      = document.getElementById("checkinForm");
const errEl     = document.getElementById("formError");
const mainRoot  = document.getElementById("mainRoot");
const menuBtn   = document.getElementById("menuBtn");
const wifiBtn   = document.getElementById("wifiBtn");
const wifiPanel = document.getElementById("wifiPanel");
const ssidText  = document.getElementById("ssidText");
const passText  = document.getElementById("passText");
const copySsid  = document.getElementById("copySsidBtn");
const copyPass  = document.getElementById("copyPassBtn");
const iosBanner = document.getElementById("iosBanner");
const openWifi  = document.getElementById("openWifi");
const wifiQR    = document.getElementById("wifiQR");
const phoneInput= document.getElementById("phone");

/* --- Setup --- */
menuBtn.href = MENU_URL;
ssidText.textContent = WIFI_SSID;
document.getElementById("ssidInline").textContent = WIFI_SSID;
wifiQR.src = QR_SRC;
passText.textContent = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";

/* Live phone feedback */
const hint = document.createElement('div');
hint.className = 'note';
phoneInput.closest('.field').appendChild(hint);
phoneInput.addEventListener('input', () => {
  const r = normalizePhone(phoneInput.value);
  if (r){
    phoneInput.classList.add('valid'); phoneInput.classList.remove('invalid');
    hint.textContent = `‚úì ${r.e164}${r.country ? ` (${r.country})` : ''}`;
  } else {
    phoneInput.classList.add('invalid'); phoneInput.classList.remove('valid');
    hint.textContent = 'Invalid phone number';
  }
});

/* Detect iOS (show QR, hide Open Settings) */
const ua = navigator.userAgent || "";
const isIOS = /iPhone|iPad|iPod/i.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
if (isIOS) { iosBanner.classList.add("show"); openWifi.style.display = "none"; }
else { iosBanner.classList.remove("show"); openWifi.style.display = "inline-flex"; }

/* Android Wi-Fi settings */
openWifi.addEventListener("click", () => {
  try { location.href = "intent:#Intent;action=android.settings.WIFI_SETTINGS;end"; } catch {}
});

/* Toggle Wi-Fi panel */
wifiBtn.addEventListener("click", () => { wifiPanel.hidden = !wifiPanel.hidden; });

/* Copy helpers */
copySsid.onclick = () => navigator.clipboard.writeText(WIFI_SSID).then(()=>alert("SSID copied!"));
copyPass.onclick = () => navigator.clipboard.writeText(WIFI_PASS).then(()=>alert("Password copied!"));

/* Form -> validate (global) -> background save -> reveal main */
form.addEventListener("submit", (e) => {
  e.preventDefault();
  const name = form.name.value.trim();
  const raw  = form.phone.value.trim();
  const r    = normalizePhone(raw);

  if (!name || name.length < 2) { errEl.textContent = "Please enter your full name."; return; }
  if (!r) { errEl.textContent = "Please enter a valid phone number (correct country)."; return; }

  // Ensure Google Sheets keeps the '+' (prefix with apostrophe)
  const phoneText = "'" + r.e164;

  postToSheet({
    name,
    phone: r.e164,                // E.164 (+country then number)
    phone_text: phoneText,        // forces text format in Sheets (keeps +)
    country_code: r.country_code, // e.g. "+92"
    national_number: r.national,  // e.g. "3088581919"
    phone_raw: raw,
    whatsapp: waLink(r.e164),
    userAgent: navigator.userAgent,
    referrer: document.referrer || ""
  });

  overlay.style.opacity = "0";
  setTimeout(() => {
    overlay.style.display = "none";
    mainRoot.classList.remove("hidden-initial");
    mainRoot.setAttribute("aria-hidden","false");
  }, 350);
});
</script>
</body>
</html>
